name: Update README Badges

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/templates/README.md.template'

jobs:
  update-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Generate badge table
        run: |
          # Run the script to generate the table file
          .github/scripts/generate-badges.sh
      
      - name: Create README from template
        run: |
          # Read the generated table file and export as environment variable
          export VERSION_BADGES_TABLE="$(cat .badges_table_content.txt)"
          
          # Create README from template
          envsubst < .github/templates/README.md.template > README_new.md
          
          # Verify the file was created
          if [ ! -f README_new.md ]; then
            echo "Error: README_new.md was not created"
            exit 1
          fi
          # Replace the old README with the new one
          mv README_new.md README.md

      - name: Update Docker Hub repository README
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPO: unifi-mongo
        run: |
          if [ -z "$DOCKERHUB_TOKEN" ] || [ -z "$DOCKERHUB_USERNAME" ]; then
            echo "Skipping Docker Hub update: missing credentials"
            exit 0
          fi

          JWT=$(curl -s -H "Content-Type: application/json" -X POST -d "{\"username\":\"$DOCKERHUB_USERNAME\",\"password\":\"$DOCKERHUB_TOKEN\"}" https://hub.docker.com/v2/users/login/ | jq -r .token)
          if [ -z "$JWT" ] || [ "$JWT" = "null" ]; then
            echo "Failed to obtain Docker Hub JWT"
            exit 1
          fi

          DATA=$(jq -n --arg fd "$(cat README.md)" '{full_description: $fd}')
          curl -s -X PATCH -H "Authorization: JWT $JWT" -H "Content-Type: application/json" -d "$DATA" "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${DOCKERHUB_REPO}/" || { echo "Docker Hub update failed"; exit 1; }
          echo "Docker Hub README updated successfully"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Stage README and commit only if staging created changes (ignore untracked files)
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-update README badges from build_info"
            git push
          fi
